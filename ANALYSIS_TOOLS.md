# Hierarchical Multi-Scale Analysis Tools

Tools for analyzing and visualizing hierarchical meta-agent emergence.

## Available Tools

### 1. Text-Based Report (No Dependencies)

**File**: `hierarchical_report.py`

Lightweight text-based analysis that works without numpy/matplotlib.

```bash
python hierarchical_report.py _results/_playground
```

**Output includes**:
- Basic statistics (steps, scales, agents)
- Condensation event timeline
- Energy evolution
- Per-scale agent breakdown
- Update statistics
- Event timeline

**Requirements**: Python 3.x only (no external dependencies)

---

### 2. Visual Analysis Suite (Full-Featured)

**File**: `hierarchical_analysis_suite.py`

Comprehensive visualization toolkit with matplotlib plots.

```bash
# Quick overview (default)
python hierarchical_analysis_suite.py --run-dir _results/_playground

# Generate all plots
python hierarchical_analysis_suite.py --run-dir _results/_playground --all

# Save plots to PNG files
python hierarchical_analysis_suite.py --run-dir _results/_playground --all --save

# Specific plot types
python hierarchical_analysis_suite.py --run-dir _results/_playground --plot overview
python hierarchical_analysis_suite.py --run-dir _results/_playground --plot condensation
python hierarchical_analysis_suite.py --run-dir _results/_playground --plot scales
python hierarchical_analysis_suite.py --run-dir _results/_playground --plot updates
```

**Plot Types**:

1. **Overview** (`--plot overview`)
   - Energy evolution over time
   - Number of scales growth
   - Total active agents
   - Stacked area plot of agents per scale
   - Condensation event markers

2. **Condensation Timeline** (`--plot condensation`)
   - When condensations occurred
   - How many meta-agents formed at each event
   - Stem plot visualization

3. **Scale Breakdown** (`--plot scales`)
   - Separate subplot for each scale
   - Total vs active agents per scale
   - Shows when agents get committed to meta-agents

4. **Update Statistics** (`--plot updates`)
   - Gradient updates applied per step
   - Top-down prior synchronizations
   - Coupling activity visualization

**Requirements**:
- Python 3.x
- numpy
- matplotlib

---

## Data Format

Both tools read from:
- `hierarchical_history.pkl` (preferred) - full history object
- `hierarchical_history.npz` (fallback) - numerical arrays only

### Expected Directory Structure

```
_results/
â””â”€â”€ _playground/
    â”œâ”€â”€ hierarchical_history.pkl    # Required
    â”œâ”€â”€ hierarchical_history.npz    # Optional fallback
    â”œâ”€â”€ config_simulation.txt
    â””â”€â”€ emergence_evolution.png     # Generated by simulation
```

### History Data Fields

The hierarchical history contains:

```python
{
    'step': [0, 1, 2, ...],                    # Evolution steps
    'total_energy': [9.56, 9.12, ...],         # Free energy per step
    'n_scales': [1, 1, 2, ...],                # Number of scales
    'n_active_agents': [5, 5, 7, ...],         # Total active across all scales
    'n_condensations': [0, 0, 2, ...],         # Meta-agents formed per step
    'n_agents_per_scale': [{0: 5}, {0: 5, 1: 2}, ...],    # Per-scale counts
    'n_active_per_scale': [{0: 5}, {0: 3, 1: 2}, ...],    # Per-scale active
    'priors_updated': [0, 2, 2, ...],          # Top-down prior syncs
    'updates_applied': [5, 5, 7, ...],         # Gradient updates applied
}
```

---

## Quick Start

### Example: Analyze a run

```bash
# 1. Quick text summary
python hierarchical_report.py _results/_playground

# 2. Generate all visualizations (if you have matplotlib)
python hierarchical_analysis_suite.py --run-dir _results/_playground --all --save
```

### Example Output Files

After running with `--save`, you'll get:

```
_results/_playground/
â”œâ”€â”€ overview_analysis.png         # Main overview dashboard
â”œâ”€â”€ condensation_analysis.png     # Condensation timeline
â”œâ”€â”€ scales_analysis.png           # Per-scale breakdown
â””â”€â”€ updates_analysis.png          # Update statistics
```

---

## Comparison to Standard Analysis Suite

### Standard `analysis_suite.py`
- Works with: `history.pkl` from `Trainer` (single-scale)
- Shows: Energy components, gauge fields, KL divergences
- Use for: Non-hierarchical multi-agent runs

### Hierarchical `hierarchical_analysis_suite.py`
- Works with: `hierarchical_history.pkl` from `HierarchicalEvolutionEngine`
- Shows: Multi-scale dynamics, emergence events, cross-scale coupling
- Use for: Hierarchical meta-agent emergence runs

---

## Troubleshooting

### "No hierarchical_history found"

Make sure you ran the simulation with hierarchical evolution enabled:

```python
from meta.hierarchical_evolution import HierarchicalEvolutionEngine, HierarchicalConfig

config = HierarchicalConfig(
    consensus_check_interval=10,
    consensus_kl_threshold=0.01,
    deactivate_constituents=False  # Continuous flow
)

engine = HierarchicalEvolutionEngine(system, config)
results = engine.evolve(n_steps=50)
```

### "No condensations occurred"

This is normal! Condensations only happen when agents reach tight consensus (KL < threshold).

To encourage condensations:
1. Increase `LAMBDA_BELIEF_ALIGN` (stronger alignment pressure)
2. Lower `consensus_kl_threshold` (looser consensus requirement)
3. Decrease learning rates (slower, more stable convergence)
4. Enable observations (`LAMBDA_OBS > 0`) to ground consensus

### "ModuleNotFoundError: No module named 'numpy'"

For the visual analysis suite, install dependencies:

```bash
pip install numpy matplotlib
```

Or use the text-based report which has no dependencies:

```bash
python hierarchical_report.py _results/_playground
```

---

## Understanding the Output

### No Condensations Example

From `hierarchical_report.py`:

```
âœ¨ CONDENSATION EVENTS
   Total condensations: 0
   Events at steps: []

âš¡ ENERGY
   Initial:       9.5693
   Final:         6.8175
   Change:       -2.7518 (-28.8%)
```

**Interpretation**:
- Energy decreased (good - agents are minimizing free energy)
- But no consensus reached (agents diverging or not aligned tightly enough)
- This is the behavior discussed in `DETECTOR_DIAGNOSIS.md`: detector runs but finds no consensus

### Active Condensation Example

```
âœ¨ CONDENSATION EVENTS
   Total condensations: 3
   Events at steps: [0, 10, 25]

   Event details:
      Step   0: 1 meta-agent(s) formed
      Step  10: 1 meta-agent(s) formed
      Step  25: 1 meta-agent(s) formed

ðŸ“ˆ FINAL STATE PER SCALE
   Scale 0: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 7/10 active
   Scale 1: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 3/3 active
```

**Interpretation**:
- 3 meta-agents formed during evolution
- Scale 0: 7 active out of 10 total (3 deactivated - committed to meta-agents)
- Scale 1: 3 active meta-agents (all formed during run)
- With continuous flow, constituents would all stay active (10/10 at scale 0)

---

## Next Steps

1. Run with observations enabled (`LAMBDA_OBS = 1`)
2. Adjust consensus threshold if needed
3. Use these tools to track emergence dynamics
4. Compare energy trajectories across different configurations
